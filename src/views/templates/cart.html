{% extends "base.html" %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ - –û–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω{% endblock %}

{% block content %}
<div class="cart-page">
    <h1 class="mb-4">
        <i class="fas fa-shopping-cart"></i> –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫
    </h1>
    
    {% if cart and cart.items %}
    <div class="row">
        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">–¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ ({{ cart.items|length }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–¢–æ–≤–∞—Ä</th>
                                    <th>–¶–µ–Ω–∞</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart.items %}
                                <tr data-item-id="{{ item.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if item.product.image_url %}
                                            <img src="{{ item.product.image_url }}" 
                                                 alt="{{ item.product.name }}" 
                                                 class="img-thumbnail me-3" 
                                                 style="width: 60px; height: 60px; object-fit: cover;">
                                            {% else %}
                                            <div class="img-thumbnail me-3 d-flex align-items-center justify-content-center" 
                                                 style="width: 60px; height: 60px; background: #f8f9fa;">
                                                <i class="fas fa-box text-muted"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ item.product.name }}</h6>
                                                <small class="text-muted">{{ item.product.category }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="product-price">{{ helpers.format_price(item.product.price, 'RUB') }}</span>
                                    </td>
                                    <td>
                                        <div class="quantity-control d-flex align-items-center">
                                            <button class="btn btn-sm btn-outline-secondary decrease-quantity" 
                                                    data-item-id="{{ item.id }}"
                                                    data-product-id="{{ item.product.id }}">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" 
                                                   class="form-control form-control-sm mx-2 quantity-input" 
                                                   value="{{ item.quantity }}" 
                                                   min="1" 
                                                   max="{{ item.product.stock }}"
                                                   style="width: 70px;"
                                                   data-item-id="{{ item.id }}"
                                                   data-product-id="{{ item.product.id }}">
                                            <button class="btn btn-sm btn-outline-secondary increase-quantity" 
                                                    data-item-id="{{ item.id }}"
                                                    data-product-id="{{ item.product.id }}"
                                                    {% if item.quantity >= item.product.stock %}disabled{% endif %}>
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            –ù–∞ —Å–∫–ª–∞–¥–µ: {{ item.product.stock }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="item-subtotal fw-bold">
                                            {{ helpers.format_price(item.get_subtotal(), 'RUB') }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger remove-item" 
                                                data-item-id="{{ item.id }}"
                                                data-product-name="{{ item.product.name }}">
                                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button class="btn btn-outline-secondary" id="clear-cart">
                            <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                        <a href="{{ url_for('get_products') }}" class="btn btn-outline-primary">
                            <i class="fas fa-plus"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Observer Pattern Demo -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-eye"></i> Observer Pattern Demo
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        –ü–∞—Ç—Ç–µ—Ä–Ω Observer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ—Ä–∑–∏–Ω–µ.
                        –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤—Å–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
                    </p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
                    </div>
                    <button class="btn btn-info" id="demo-observer">
                        <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ Observer
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">–ò—Ç–æ–≥ –∑–∞–∫–∞–∑–∞</h5>
                </div>
                <div class="card-body">
                    <div class="order-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>–¢–æ–≤–∞—Ä—ã ({{ cart.get_item_count() }} —à—Ç.)</span>
                            <span id="subtotal">{{ helpers.format_price(cart.get_total(), 'RUB') }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                            <span id="shipping-cost">{{ helpers.format_price(0, 'RUB') }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>–ù–∞–ª–æ–≥</span>
                            <span id="tax">{{ helpers.format_price(cart.get_total() * 0.2, 'RUB') }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <h5>–ò—Ç–æ–≥–æ</h5>
                            <h5 id="order-total">{{ helpers.format_price(cart.get_total() * 1.2, 'RUB') }}</h5>
                        </div>
                        
                        <!-- Strategy Pattern Demo - –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã -->
                        <div class="mb-3">
                            <label class="form-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                            <select class="form-select" id="payment-method">
                                <option value="credit_card">üí≥ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                                <option value="paypal">üåê PayPal</option>
                                <option value="crypto">‚Çø –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
                            </select>
                            <small class="text-muted">
                                Strategy Pattern: –∫–∞–∂–¥—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–≤–æ—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
                            </small>
                            
                            <!-- –§–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞) -->
                            <div id="credit-card-form" class="payment-form mt-3">
                                <div class="mb-2">
                                    <input type="text" class="form-control" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" id="card-number">
                                </div>
                                <div class="row mb-2">
                                    <div class="col">
                                        <input type="text" class="form-control" placeholder="–ú–ú/–ì–ì" id="card-expiry">
                                    </div>
                                    <div class="col">
                                        <input type="text" class="form-control" placeholder="CVV" id="card-cvv">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="paypal-form" class="payment-form mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fab fa-paypal"></i>
                                    –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–∞–π—Ç PayPal –¥–ª—è –æ–ø–ª–∞—Ç—ã
                                </div>
                            </div>
                            
                            <div id="crypto-form" class="payment-form mt-3" style="display: none;">
                                <div class="alert alert-warning">
                                    <i class="fas fa-coins"></i>
                                    –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã: 
                                    <code>0x742d35Cc6634C0532925a3b844Bc9e</code>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success btn-lg w-100" id="checkout-btn">
                            <i class="fas fa-lock"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
                        </button>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å 
                                <a href="#">—É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Facade Pattern Demo -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-building"></i> Facade Pattern Demo
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        –ü–∞—Ç—Ç–µ—Ä–Ω Facade –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–ª–æ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
                        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É –ø–æ–∫—É–ø–∫–∏ —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –º–µ—Ç–æ–¥.
                    </p>
                    <button class="btn btn-warning w-100" id="demo-facade">
                        <i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä–∞—è –ø–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Facade
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
    <div class="empty-cart text-center py-5">
        <div class="empty-cart-icon mb-4">
            <i class="fas fa-shopping-cart fa-5x text-muted"></i>
        </div>
        <h3 class="mb-3">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
        <p class="text-muted mb-4">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</p>
        <a href="{{ url_for('get_products') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-store"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cartData = {{ cart.to_dict()|tojson|safe if cart else 'null' }};
        
        // Observer Pattern Demo
        document.getElementById('demo-observer')?.addEventListener('click', function() {
            console.log('=== Observer Pattern Demo ===');
            
            // –°–æ–∑–¥–∞–µ–º Subject
            class CartSubject {
                constructor() {
                    this.observers = [];
                }
                
                subscribe(observer) {
                    this.observers.push(observer);
                    console.log('Observer subscribed:', observer.name);
                }
                
                unsubscribe(observer) {
                    this.observers = this.observers.filter(obs => obs !== observer);
                }
                
                notify(data) {
                    console.log('Notifying observers:', this.observers.length);
                    this.observers.forEach(observer => observer.update(data));
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º Observers
            class CartCounterObserver {
                update(data) {
                    console.log('CartCounterObserver: Cart updated', data);
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –æ–±–Ω–æ–≤–ª—è–ª—Å—è –±—ã —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                }
            }
            
            class PriceCalculatorObserver {
                update(data) {
                    console.log('PriceCalculatorObserver: Recalculating total', data);
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–ª–∞—Å—å –±—ã —Å—É–º–º–∞
                }
            }
            
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Observer Pattern
            const cartSubject = new CartSubject();
            cartSubject.subscribe(new CartCounterObserver());
            cartSubject.subscribe(new PriceCalculatorObserver());
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
            setTimeout(() => {
                console.log('Simulating cart change...');
                cartSubject.notify({ itemId: 1, quantity: 2 });
            }, 1000);
            
            alert('Observer Pattern demo –∑–∞–ø—É—â–µ–Ω. –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
        });
        
        // Facade Pattern Demo
        document.getElementById('demo-facade')?.addEventListener('click', function() {
            console.log('=== Facade Pattern Demo ===');
            
            // –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã Facade
            alert('Facade Pattern: –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, –æ–ø–ª–∞—Ç–∞, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ purchase_product()');
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –≤—ã–∑–æ–≤ API
            fetch('/api/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': AppConfig.csrfToken
                },
                body: JSON.stringify({
                    user_id: AppConfig.userId || 1,
                    product_id: 1,
                    quantity: 1,
                    payment_method: 'credit_card'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ Facade!\n–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${data.data.order_number}`);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Facade demo error:', error);
                alert('–î–µ–º–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)');
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                const itemId = this.dataset.itemId;
                const productId = this.dataset.productId;
                const quantity = parseInt(this.value);
                
                updateCartItem(itemId, productId, quantity);
            });
        });
        
        // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        document.querySelectorAll('.increase-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const productId = this.dataset.productId;
                const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
                
                if (input) {
                    let quantity = parseInt(input.value) + 1;
                    input.value = quantity;
                    updateCartItem(itemId, productId, quantity);
                }
            });
        });
        
        // –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        document.querySelectorAll('.decrease-quantity').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const productId = this.dataset.productId;
                const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
                
                if (input) {
                    let quantity = parseInt(input.value) - 1;
                    if (quantity < 1) quantity = 1;
                    input.value = quantity;
                    updateCartItem(itemId, productId, quantity);
                }
            });
        });
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const productName = this.dataset.productName;
                
                if (confirm(`–£–¥–∞–ª–∏—Ç—å "${productName}" –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?`)) {
                    removeCartItem(itemId);
                }
            });
        });
        
        // –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
        document.getElementById('clear-cart')?.addEventListener('click', function() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É?')) {
                clearCart();
            }
        });
        
        // Strategy Pattern - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        document.getElementById('payment-method')?.addEventListener('change', function() {
            const method = this.value;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã
            document.querySelectorAll('.payment-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É
            const formId = method + '-form';
            const form = document.getElementById(formId);
            if (form) {
                form.style.display = 'block';
            }
            
            console.log('Strategy Pattern: –í—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø–ª–∞—Ç—ã:', method);
        });
        
        // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        document.getElementById('checkout-btn')?.addEventListener('click', function() {
            const paymentMethod = document.getElementById('payment-method').value;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã –¥–ª—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã
            if (paymentMethod === 'credit_card') {
                const cardNumber = document.getElementById('card-number').value;
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;
                
                if (!cardNumber || !cardExpiry || !cardCvv) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã');
                    return;
                }
            }
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
            alert(`–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: ${paymentMethod}\n\n–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.`);
            
            // –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
            simulateOrderCreation(paymentMethod);
        });
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function updateCartItem(itemId, productId, quantity) {
            try {
                const response = await fetch(`/cart/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': AppConfig.csrfToken
                    },
                    body: JSON.stringify({ quantity: quantity })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –≤ —Ç–∞–±–ª–∏—Ü–µ
                    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                    if (row) {
                        const subtotalElement = row.querySelector('.item-subtotal');
                        if (subtotalElement) {
                            subtotalElement.textContent = formatPrice(data.data.subtotal);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
                    updateOrderSummary(data.data.cart_total);
                    
                    showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Update error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        
        async function removeCartItem(itemId) {
            try {
                const response = await fetch(`/cart/items/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-Token': AppConfig.csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                    if (row) {
                        row.remove();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
                    updateOrderSummary(data.data.cart_total);
                    
                    // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    if (data.data.item_count === 0) {
                        location.reload();
                    }
                    
                    showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'success');
                }
            } catch (error) {
                console.error('Remove error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        
        async function clearCart() {
            try {
                const response = await fetch(`/cart/{{ cart.id }}/clear`, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': AppConfig.csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Clear error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        
        function updateOrderSummary(total) {
            const subtotalElement = document.getElementById('subtotal');
            const orderTotalElement = document.getElementById('order-total');
            const taxElement = document.getElementById('tax');
            
            if (subtotalElement && orderTotalElement && taxElement) {
                const tax = total * 0.2;
                const orderTotal = total + tax;
                
                subtotalElement.textContent = formatPrice(total);
                taxElement.textContent = formatPrice(tax);
                orderTotalElement.textContent = formatPrice(orderTotal);
            }
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(price);
        }
        
        function showNotification(message, type) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ main.js
            if (typeof window.showNotification === 'function') {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
        
        function simulateOrderCreation(paymentMethod) {
            console.log('Simulating order creation with payment method:', paymentMethod);
            
            // –ò–º–∏—Ç–∞—Ü–∏—è Strategy Pattern
            const paymentStrategies = {
                'credit_card': () => '–û–ø–ª–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞',
                'paypal': () => '–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ PayPal',
                'crypto': () => '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'
            };
            
            const strategy = paymentStrategies[paymentMethod];
            if (strategy) {
                const message = strategy();
                console.log('Strategy result:', message);
            }
        }
    });
</script>
{% endblock %}